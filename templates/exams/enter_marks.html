{% extends 'base.html' %}

{% block title %}Enter Marks - Exam Management System{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{% url 'exams:enter_marks_spreadsheet' %}" class="btn btn-outline-success">
        <i class="fas fa-file-excel me-2"></i>Enter Marks via Spreadsheet
    </a>
</div>
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-edit text-primary me-2"></i>
            Enter Marks
        </h2>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Bulk Entry Form -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Bulk Entry Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="bulkEntryForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="course" class="form-label">
                                <i class="fas fa-graduation-cap me-1"></i>Course
                            </label>
                            <select name="course" id="course" class="form-control" required>
                                <option value="">Select Course</option>
                                {% for course in courses %}
                                    <option value="{{ course.id }}">{{ course.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Or type a new course name below</small>
                            <input type="text" id="new_course" class="form-control mt-1" placeholder="Type new course name">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="school" class="form-label">
                                <i class="fas fa-school me-1"></i>School
                            </label>
                            <select name="school" id="school" class="form-control" required>
                                <option value="">Select School</option>
                                {% for school in schools %}
                                    <option value="{{ school.id }}">{{ school.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="unit" class="form-label">
                                <i class="fas fa-book me-1"></i>Unit
                            </label>
                            <select name="unit" id="unit" class="form-control" required>
                                <option value="">Select Unit</option>
                                {% for unit in units %}
                                    <option value="{{ unit.id }}">{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Or type a new unit name below</small>
                            <input type="text" id="new_unit" class="form-control mt-1" placeholder="Type new unit name">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="term" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Term
                            </label>
                            <select name="term" id="term" class="form-control" required>
                                <option value="">Select Term</option>
                                {% for term in terms %}
                                    <option value="{{ term }}">{{ term }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="level" class="form-label">
                                <i class="fas fa-layer-group me-1"></i>Level
                            </label>
                            <select name="level" id="level" class="form-control" required>
                                <option value="">Select Level</option>
                                {% for level in levels %}
                                    <option value="{{ level }}">{{ level }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="year" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>Year
                            </label>
                            <select name="year" id="year" class="form-control" required>
                                <option value="">Select Year</option>
                                {% for year in years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button type="button" id="loadStudentsBtn" class="btn btn-info w-100">
                                <i class="fas fa-users me-2"></i>Load Students
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Students Table -->
<div class="row mt-4" id="studentsTableSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Student Marks Entry
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="marksEntryForm">
                    {% csrf_token %}
                    <input type="hidden" name="bulk_save" value="1">
                    
                    <!-- Copy the configuration fields -->
                    <input type="hidden" name="course" id="course_hidden">
                    <input type="hidden" name="school" id="school_hidden">
                    <input type="hidden" name="unit" id="unit_hidden">
                    <input type="hidden" name="term" id="term_hidden">
                    <input type="hidden" name="level" id="level_hidden">
                    <input type="hidden" name="year" id="year_hidden">
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="studentsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 5%; color: black;">#</th>
                                    <th style="width: 25%; color: black;">Student Name</th>
                                    <th style="width: 15%;">Admission Number</th>
                                    <th style="width: 15%;color: black;">CAT 1 (0-30)</th>
                                    <th style="width: 15%;color: black;">CAT 2 (0-30)</th>
                                    <th style="width: 15%;color: black;">End Term (0-70)</th>
                                    <th style="width: 10%;color: black;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Save All Marks
                            </button>
                        </div>
                    </div>
                

                </form>
            </div>
        </div>
    </div>
</div>

<!-- Multi-Unit Entry Form -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>Multi-Unit Entry Form
                </h5>
            </div>
                <div class="card-body">
                {% if message %}
                    <div class="alert alert-success">{{ message }}</div>
                {% endif %}
                <form method="post">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="student" class="form-label">Student</label>
                            <select name="student_id" id="student" class="form-control" required {% if selected_student %}disabled{% endif %}>
                                <option value="">Select Student</option>
                                {% for s in students %}
                                    <option value="{{ s.id }}" {% if selected_student and s.id == selected_student.id %}selected{% endif %}>{{ s.name }} ({{ s.registration_number }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="year" class="form-label">Year</label>
                            <select name="year" id="year" class="form-control" required {% if selected_year %}disabled{% endif %}>
                                <option value="">Select Year</option>
                                {% for y in years %}
                                    <option value="{{ y }}" {% if selected_year and y|stringformat:'s' == selected_year|stringformat:'s' %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="term" class="form-label">Term</label>
                            <select name="term" id="term" class="form-control" required {% if selected_term %}disabled{% endif %}>
                                <option value="">Select Term</option>
                                {% for t in terms %}
                                    <option value="{{ t }}" {% if selected_term and t == selected_term %}selected{% endif %}>{{ t }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% if not selected_student or not selected_year or not selected_term %}
                        <button type="submit" name="select_student" class="btn btn-primary w-100">Next</button>
                    {% endif %}
                </form>
                {% if selected_student and selected_year and selected_term %}
                <hr>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="student_id" value="{{ selected_student.id }}">
                    <input type="hidden" name="year" value="{{ selected_year }}">
                    <input type="hidden" name="term" value="{{ selected_term }}">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center mx-auto" style="width: auto;">
                            <thead class="table-light">
                                <tr>
                                    <th>Unit</th>
                                    <th>CAT 1</th>
                                    <th>CAT 2</th>
                                    <th>End Term</th>
                                </tr>
                            </thead>
                            <tbody id="units-table-body">
                                {% for mark in unit_marks %}
                                <tr>
                                    <td>
                                        <select name="unit_id_{{ forloop.counter }}" class="form-control unit-select" disabled>
                                            <option value="{{ mark.unit.id }}" selected>{{ mark.unit.name }}</option>
                                            <option value="other">Other...</option>
                                        </select>
                                        <input type="hidden" name="unit_id_{{ forloop.counter }}" value="{{ mark.unit.id }}">
                                        <input type="text" name="unit_name_{{ forloop.counter }}" class="form-control mt-2 d-none" placeholder="Enter unit name">
                                    </td>
                                    <td><input type="number" name="cat1_{{ forloop.counter }}" class="form-control" min="0" max="30" step="0.01" value="{{ mark.cat1 }}"></td>
                                    <td><input type="number" name="cat2_{{ forloop.counter }}" class="form-control" min="0" max="30" step="0.01" value="{{ mark.cat2 }}"></td>
                                    <td><input type="number" name="endterm_{{ forloop.counter }}" class="form-control" min="0" max="70" step="0.01" value="{{ mark.endterm }}"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="text-center">
                            <button type="button" id="add-row-btn" class="btn btn-secondary mt-2">Add Unit</button>
                        </div>
                    </div>
                    <button type="submit" name="save_marks" class="btn btn-success w-100">Save Marks</button>
                </form>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const addButton = document.getElementById('add-row-btn');
                    let rowCount = {{ unit_marks|length }};
                    let availableUnits = [
                        {% for unit in available_units %}
                            {id: {{ unit.id }}, name: "{{ unit.name|escapejs }}"},
                        {% endfor %}
                    ];
                    if (addButton) {
                        addButton.addEventListener('click', function() {
                            rowCount++;
                            const tbody = document.getElementById('units-table-body');
                            const newRow = document.createElement('tr');
                            let options = '';
                            for (let u of availableUnits) {
                                options += `<option value="${u.id}">${u.name}</option>`;
                            }
                            options += `<option value="other">Other...</option>`;
                            newRow.innerHTML = `
                                <td>
                                    <select name="unit_id_${rowCount}" class="form-control unit-select">
                                        ${options}
                                    </select>
                                    <input type="text" name="unit_name_${rowCount}" class="form-control mt-2 d-none" placeholder="Enter unit name">
                                </td>
                                <td><input type="number" name="cat1_${rowCount}" class="form-control" min="0" max="30" step="0.01"></td>
                                <td><input type="number" name="cat2_${rowCount}" class="form-control" min="0" max="30" step="0.01"></td>
                                <td><input type="number" name="endterm_${rowCount}" class="form-control" min="0" max="70" step="0.01"></td>
                            `;
                            tbody.appendChild(newRow);
                            // Show/hide text input if 'Other...' is selected
                            const select = newRow.querySelector('.unit-select');
                            const textInput = newRow.querySelector('input[type="text"]');
                            select.addEventListener('change', function() {
                                if (this.value === 'other') {
                                    textInput.classList.remove('d-none');
                                    textInput.required = true;
                                } else {
                                    textInput.classList.add('d-none');
                                    textInput.required = false;
                                }
                            });
                        });
                    }
                    // For pre-filled rows, handle 'Other...' if ever enabled
                    document.querySelectorAll('.unit-select').forEach(function(select) {
                        const textInput = select.parentElement.querySelector('input[type="text"]');
                        select.addEventListener('change', function() {
                            if (this.value === 'other') {
                                textInput.classList.remove('d-none');
                                textInput.required = true;
                            } else {
                                textInput.classList.add('d-none');
                                textInput.required = false;
                            }
                        });
                    });
                });
                </script>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- End Multi-Unit Entry Form -->

<!-- Quick Stats -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-user-graduate fa-2x text-primary mb-2"></i>
                <h5>{{ students.count }}</h5>
                <p class="text-muted">Total Students</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-subject fa-2x text-success mb-2"></i>
                <h5>{{ units.count }}</h5>
                <p class="text-muted">Total Units</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-info-circle fa-2x text-info mb-2"></i>
                <h5>Bulk Entry</h5>
                <p class="text-muted">Excel-like Format</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Students data for bulk entry
    const studentsByCourse = {{ students_data_json|safe }};
    
    // Load Students Button
    document.getElementById('loadStudentsBtn').addEventListener('click', function() {
        const courseSelect = document.getElementById('course');
        const newCourseInput = document.getElementById('new_course');
        const unitSelect = document.getElementById('unit');
        const newUnitInput = document.getElementById('new_unit');
        const school = document.getElementById('school').value;
        const term = document.getElementById('term').value;
        const level = document.getElementById('level').value;
        const year = document.getElementById('year').value;
        
        // Determine course value
        let courseValue = courseSelect.value;
        if (!courseValue && newCourseInput.value.trim()) {
            courseValue = newCourseInput.value.trim();
        }
        
        // Determine unit value
        let unitValue = unitSelect.value;
        if (!unitValue && newUnitInput.value.trim()) {
            unitValue = newUnitInput.value.trim();
        }
        
        if (!courseValue || !school || !unitValue || !term || !level || !year) {
            alert('Please fill in all configuration fields first.');
            return;
        }
        
        // Copy values to hidden fields
        document.getElementById('course_hidden').value = courseValue;
        document.getElementById('school_hidden').value = school;
        document.getElementById('unit_hidden').value = unitValue;
        document.getElementById('term_hidden').value = term;
        document.getElementById('level_hidden').value = level;
        document.getElementById('year_hidden').value = year;
        
        // Load students for the selected course
        loadStudentsForCourse(courseValue);
        
        // Show the table section
        document.getElementById('studentsTableSection').style.display = 'block';
    });
    
    // Form validation before submission
    document.getElementById('marksEntryForm').addEventListener('submit', function(e) {
        const courseValue = document.getElementById('course_hidden').value;
        const unitValue = document.getElementById('unit_hidden').value;
        const termValue = document.getElementById('term_hidden').value;
        const yearValue = document.getElementById('year_hidden').value;
        
        if (!courseValue || !unitValue || !termValue || !yearValue) {
            e.preventDefault();
            alert('Please configure all settings (course, unit, term, year) before saving marks.');
            return;
        }
        
        // Check if there are any students in the table
        const tbody = document.getElementById('studentsTableBody');
        if (tbody.children.length === 0) {
            e.preventDefault();
            alert('No students found. Please load students or add new students before saving.');
            return;
        }
        
        // Debug: Log form data
        console.log('DEBUG: Form submission - checking for new students...');
        const formData = new FormData(this);
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('cat1_new_') || key.startsWith('student_name_') || key.startsWith('admission_number_')) {
                console.log(`DEBUG: Found key: ${key}, value: ${value}`);
            }
        }
    });
    
    function loadStudentsForCourse(courseId) {
        const tbody = document.getElementById('studentsTableBody');
        tbody.innerHTML = '';
        
        // Find students for this course
        const courseStudents = studentsByCourse[courseId] || [];
        
        if (courseStudents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No students found for this course.</td></tr>';
            return;
        }
        
        // Get current configuration values
        const unitValue = document.getElementById('unit_hidden').value || '';
        const termValue = document.getElementById('term_hidden').value || '';
        const yearValue = document.getElementById('year_hidden').value || '';
        
        // If we have all configuration values, fetch existing marks
        if (unitValue && termValue && yearValue) {
            fetchExistingMarks(courseId, unitValue, termValue, yearValue, courseStudents, tbody);
        } else {
            // Create table rows without existing marks
            createStudentRows(courseStudents, tbody, {});
        }
    }
    
    function fetchExistingMarks(courseId, unitValue, termValue, yearValue, courseStudents, tbody) {
        const params = new URLSearchParams({
            course_id: courseId,
            unit_id: unitValue,
            term: termValue,
            year: yearValue
        });
        
        fetch(`/get-existing-marks/?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching existing marks:', data.error);
                    createStudentRows(courseStudents, tbody, {});
                } else {
                    createStudentRows(courseStudents, tbody, data.existing_marks);
                }
            })
            .catch(error => {
                console.error('Error fetching existing marks:', error);
                createStudentRows(courseStudents, tbody, {});
            });
    }
    
    function createStudentRows(courseStudents, tbody, existingMarks) {
        courseStudents.forEach((student, index) => {
            const marks = existingMarks[student.id] || {};
            const hasExistingMarks = marks.cat1_score || marks.cat2_score || marks.end_term_score;
            
            const row = document.createElement('tr');
            if (hasExistingMarks) {
                row.className = 'table-warning';
                row.title = 'This student already has marks for this unit/term/year';
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    ${student.name}
                    ${hasExistingMarks ? '<i class="fas fa-check-circle text-success ms-2" title="Existing marks found"></i>' : ''}
                </td>
                <td>${student.registration_number}</td>
                <td>
                    <input type="number" name="cat1_${student.id}" class="form-control cat1-input" 
                           min="0" max="30" step="0.01" placeholder="0-30" value="${marks.cat1_score || ''}">
                </td>
                <td>
                    <input type="number" name="cat2_${student.id}" class="form-control cat2-input" 
                           min="0" max="30" step="0.01" placeholder="0-30" value="${marks.cat2_score || ''}">
                </td>
                <td>
                    <input type="number" name="endterm_${student.id}" class="form-control endterm-input" 
                           min="0" max="70" step="0.01" placeholder="0-70" value="${marks.end_term_score || ''}">
                </td>
                <td>
                    <span class="total-score">${calculateTotal(marks.cat1_score, marks.cat2_score, marks.end_term_score)}</span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add event listeners for real-time calculation
        addCalculationListeners();
        
        // Show notification if existing marks were loaded
        const existingMarksCount = Object.values(existingMarks).filter(marks => 
            marks.cat1_score || marks.cat2_score || marks.end_term_score
        ).length;
        
        if (existingMarksCount > 0) {
            const unitValue = document.getElementById('unit_hidden').value;
            const termValue = document.getElementById('term_hidden').value;
            const yearValue = document.getElementById('year_hidden').value;
            
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show mt-3';
            notification.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Existing marks loaded!</strong> ${existingMarksCount} student(s) already have marks for ${unitValue} (${termValue}, ${yearValue}). 
                You can update these marks or leave them unchanged.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const tableSection = document.getElementById('studentsTableSection');
            tableSection.insertBefore(notification, tableSection.firstChild);
        }
    }
    
    function calculateTotal(cat1, cat2, endterm) {
        const cat1Val = parseFloat(cat1) || 0;
        const cat2Val = parseFloat(cat2) || 0;
        const endtermVal = parseFloat(endterm) || 0;
        const catAverage = (cat1Val + cat2Val) / 2;
        const total = catAverage + endtermVal;
        return total.toFixed(2);
    }
    
    function addCalculationListeners() {
        const rows = document.querySelectorAll('#studentsTableBody tr');
        rows.forEach(row => {
            const cat1Input = row.querySelector('.cat1-input');
            const cat2Input = row.querySelector('.cat2-input');
            const endtermInput = row.querySelector('.endterm-input');
            const totalSpan = row.querySelector('.total-score');
            
            if (cat1Input && cat2Input && endtermInput && totalSpan) {
                const calculateTotal = () => {
                    const cat1 = parseFloat(cat1Input.value) || 0;
                    const cat2 = parseFloat(cat2Input.value) || 0;
                    const endterm = parseFloat(endtermInput.value) || 0;
                    const catAverage = (cat1 + cat2) / 2;
                    const total = catAverage + endterm;
                    totalSpan.textContent = total.toFixed(2);
                };
                
                cat1Input.addEventListener('input', calculateTotal);
                cat2Input.addEventListener('input', calculateTotal);
                endtermInput.addEventListener('input', calculateTotal);
            }
        });
    }
    
    // Single entry form calculations (existing functionality)
    const cat1Input = document.getElementById('{{ form.cat1_score.id_for_label }}');
    const cat2Input = document.getElementById('{{ form.cat2_score.id_for_label }}');
    const endTermInput = document.getElementById('{{ form.end_term_score.id_for_label }}');
    
    const catAverageDisplay = document.getElementById('catAverage');
    const totalAverageDisplay = document.getElementById('totalAverage');
    const gradeDisplay = document.getElementById('grade');
    
    function calculateAverages() {
        const cat1 = parseFloat(cat1Input.value) || 0;
        const cat2 = parseFloat(cat2Input.value) || 0;
        const endTerm = parseFloat(endTermInput.value) || 0;
        
        // Calculate CAT average
        const catAverage = (cat1 + cat2) / 2;
        catAverageDisplay.textContent = catAverage.toFixed(2);
        
        // Calculate total average
        const totalAverage = catAverage + endTerm;
        totalAverageDisplay.textContent = totalAverage.toFixed(2);
        
        // Calculate grade
        let grade = '-';
        if (totalAverage >= 80) {
            grade = 'A';
        } else if (totalAverage >= 70) {
            grade = 'B';
        } else if (totalAverage >= 60) {
            grade = 'C';
        } else if (totalAverage >= 50) {
            grade = 'D';
        } else if (totalAverage > 0) {
            grade = 'F';
        }
        gradeDisplay.textContent = grade;
        
        // Update colors based on performance
        if (totalAverage >= 70) {
            totalAverageDisplay.parentElement.className = 'alert alert-success text-center';
        } else if (totalAverage >= 50) {
            totalAverageDisplay.parentElement.className = 'alert alert-warning text-center';
        } else if (totalAverage > 0) {
            totalAverageDisplay.parentElement.className = 'alert alert-danger text-center';
        } else {
            totalAverageDisplay.parentElement.className = 'alert alert-secondary text-center';
        }
    }
    
    // Add event listeners for real-time calculation
    if (cat1Input && cat2Input && endTermInput) {
    cat1Input.addEventListener('input', calculateAverages);
    cat2Input.addEventListener('input', calculateAverages);
    endTermInput.addEventListener('input', calculateAverages);
    
    // Initial calculation
    calculateAverages();
    }
    
    // Form validation
    const singleEntryForm = document.getElementById('singleEntryForm');
    if (singleEntryForm) {
        singleEntryForm.addEventListener('submit', function(e) {
        const cat1 = parseFloat(cat1Input.value) || 0;
        const cat2 = parseFloat(cat2Input.value) || 0;
        const endTerm = parseFloat(endTermInput.value) || 0;
        
        if (cat1 < 0 || cat1 > 30) {
            e.preventDefault();
            alert('CAT 1 score must be between 0 and 30');
            return;
        }
        
        if (cat2 < 0 || cat2 > 30) {
            e.preventDefault();
            alert('CAT 2 score must be between 0 and 30');
            return;
        }
        
        if (endTerm < 0 || endTerm > 70) {
            e.preventDefault();
            alert('End-term score must be between 0 and 70');
            return;
        }
    });
    }
});
</script>
{% endblock %}
